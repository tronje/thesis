% rubber: setlist arguments --shell-escape

\documentclass[
    fontsize=12pt,
    headings=small,
    parskip=half,
    bibliography=totoc,
    numbers=noenddot,
    open=any
    ]{scrreprt}

\usepackage[utf8]{inputenc}
% \usepackage{datetime2}
\usepackage[
    autostyle,
    ]{csquotes}
\usepackage{amsmath}
\usepackage[titletoc,title]{appendix}
\usepackage{booktabs}
\usepackage{pifont}
\usepackage{marvosym}
\usepackage{minted}
\usepackage{graphicx}
\usepackage{parskip}
\usepackage{hyperref}
\usepackage{setspace}
\usepackage{acronym}
% \usepackage{float}
\usepackage[scaled=.92]{helvet}
\usepackage{courier}
\usepackage[table]{xcolor}
\usepackage[
    a4paper,
    margin=2.54cm,
    marginparwidth=2.0cm,
    right=2.0cm,
    footskip=1.0cm
    ]{geometry}

\usepackage[
    url=true,
    style=numeric,
    alldates=long,
    dateabbrev=false
]{biblatex}
% \usepackage[
%     style=alphabetic,
%     backend=biber,
%     %backref=true
%     ]{biblatex}
\addbibresource{literature.bib}

\urlstyle{rm}

\clubpenalty=10000

\widowpenalty=10000
\displaywidowpenalty=10000
\usepackage{float}
\floatstyle{plaintop}
\restylefloat{table}
\usepackage{ifdraft}
\pagestyle{plain}
\deffootnote{1em}{1em}{\thefootnotemark.\ }

\titlehead{
    \begin{center}
        % \includegraphics[width=4cm]{images/uhh_logo_minimal.png}\\
        \includegraphics[width=8cm]{images/UHH-Logo_2010_Farbe_RGB_hires_nomargin.png}\\
        \medskip
        Department of Computer Science
    \end{center}
}

\setlength{\belowcaptionskip}{10pt plus 1pt minus 1pt}
\setlength{\textfloatsep}{20pt plus 1pt minus 1pt}
\setlength{\floatsep}{20pt plus 1pt minus 1pt}

\newcommand{\dominik}[1]{\textcolor{orange}{\textbf{Notiz: #1}}}
\newcommand{\todo}[1]{\textcolor{red}{\textbf{TODO: #1}}}
\newcommand{\cmark}{\textcolor{green}{\ding{51}}}
% \newcommand{\xmark}{\textcolor{red}{\ding{55}}}
\newcommand{\xmark}{\textcolor{red}{-}}
\newcommand{\qmark}{\textcolor{orange}{\textbf{?}}}

\title{
    Implementation of browser fingerprinting detection \\
    and integration into PrivacyScore
}

\author{Tronje Krabbe}

\date{\today}

\begin{document}
\hypersetup{hidelinks}

\frenchspacing

% \maketitle

% \newpage
% \thispagestyle{empty}
% % \addcontentsline{toc}{chapter}{Muster des Deckblatts}
% \begin{titlepage}% {{{
% \includegraphics[width=6.8cm]{images/up-uhh-logo-u-2010-u-farbe-u-rgb.pdf}
% \begin{center}\large
% 	% Universität Hamburg \par
% 	% Fachbereich Informatik
%     \vfill
% 	\makeatletter
% 	{\Large\textsf{\textbf{\@title}}\par}
% 	\makeatother
% 	\vfill
%     A thesis submitted for the degree of \\
%     \textit{Bachelor of Science} \\
%     in \\
%     \textit{Computer Science}
% 	\vfill
%     by
% 	\par\bigskip
% 	\makeatletter
% 	{\@author} \par
% 	\makeatother
% 	born 11. August 1994 in Hamburg \par
% 	matriculation number 6435002
% 	\vfill
% 	\makeatletter
% 	submitted {\@date}
% 	\makeatother
% 	\vfill
% 	Supervisor: Dipl.-Inf. Tobias Müller \par
% 	First reviewer: Prof. Dr.-Ing. Hannes Federrath \par
% 	Second reviewer: Prof. Dr. Dominik Herrmann
% \end{center}
% \end{titlepage}% }}}

\newpage
\thispagestyle{empty}
% \addcontentsline{toc}{chapter}{Muster des Deckblatts}
\begin{titlepage}% {{{
\includegraphics[width=6.8cm]{images/up-uhh-logo-u-2010-u-farbe-u-rgb.pdf}
\begin{center}\Large
	% Universität Hamburg \par
	% Fachbereich Informatik
	\vfill
	Bachelorarbeit
	\vfill
	\makeatletter
	{\Large\textsf{\textbf{\@title}}\par}
	\makeatother
	\vfill
	vorgelegt von
	\par\bigskip
	\makeatletter
	{\@author} \par
	\makeatother
	geb. am 11. August 1994 in Hamburg \par
	Matrikelnummer 6435002 \par
	Studiengang Informatik
	\vfill
	\makeatletter
	eingereicht am {\@date}
	\makeatother
	\vfill
	Betreuer: Dipl.-Inf. Tobias Müller \par
	Erstgutachter: Prof. Dr.-Ing. Hannes Federrath \par
	Zweitgutachter: Prof. Dr. Dominik Herrmann
\end{center}
\end{titlepage}% }}}

\null\newpage

\chapter*{Abstract}
% Worum geht es, warum ist das Thema interessant/wichtig, wie bist du vorgegangen, was kam heraus, was bedeutet das für die Zukunft oder was haben wir durch die Arbeit gelernt? 

Many websites use cookies or other means to track users across the web. This is often
done for marketing or advertising purposes. Oftentimes, cookies are insufficient to reliably
track a user, as they can be deleted by the user. Alternatively, to track a user, a fingerprint
of their device and web browser can be constructed, which can identify the user uniquely
within a large set of users.

This thesis aims to explore modern fingerprinting techniques, and to implement
automated fingerprinting detection. This creates transparency for users
who are concerned about their privacy, and who do not wish to have their online
activity tracked and recorded.

We have explored related work on fingerprinting and fingerprinting detection,
analysed many sites that use fingerprintable attributes or APIs by hand,
and implemented an automated fingerprinting detection method into PrivacyScore,
a service that can scan and analyse a website in regards to its privacy and security.

\setcounter{tocdepth}{1}
\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter Start                                                            %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Introduction}
\label{chap:introduction}

When browsing the web, users can be tracked through the use of cookies, which store information on the user's computer
that can also be accessed by a remote server.
If users wish not to be trackable, they can modify or delete any cookie as they see fit.
There are, however, other methods of uniquely identifying users and tracking them during their use of the internet,
which are not as easily mitigated as cookies \cite{am_i_unique}. One of these methods is called ``browser fingerprinting'',
and it will be the focus of this thesis.

Browser fingerprinting, also known as device fingerprinting, and in the following often simply referred to as ``fingerprinting'',
works by analyzing a web browser's configuration and settings; mostly installed fonts and HTML5 canvas behavior
\cite{DBLP:conf/ccs/EnglehardtN16}, as well as
language settings, time zone settings, installed add-ons, and more. Flash is also sometimes used, though
its end-of-life lies in the foreseeable future, reportedly in the year
2020 \cite{flash_eol}.
Fingerprinting through Flash and the detection thereof will thus not be within the scope of this thesis.

The above attributes are readily available to be collected through JavaScript functions. Simply recording
all function calls made by the JavaScript front end of a website can reveal whether fingerprinting is likely to
be taking place or not \cite{faiz2014browser, panopticlick}.

Techniques used to identify and track users across different websites without
their knowledge or their ability to easily intervene, violates their privacy; by creating a fingerprint
of a user's browser, with sufficiently sophisticated techniques, one can uniquely identify one user
among hundreds of thousands \cite{am_i_unique}, re-instate any cookies the user may have deleted,
or simply track and analyse their use of any number of web services for a multitude of malicious reasons \cite{eckersley2010unique}.
Methods exist to mitigate the effectiveness of browser fingerprinting, such as the one presented
in \cite{laperdrix2015mitigating};
these are, however, usually quite complicated and thus not suitable for ordinary users.
The author has therefore implemented a technique to recognize when a website is deploying browser fingerprinting,
and along the way explored the common techniques used to construct a fingerprint. The resulting software has been integrated into
PrivacyScore\footnote{\url{https://privacyscore.org}}, a web-service to test and rank websites according to the extent to which they
respect their users' privacy \cite{privacyscore}.
Informing users about websites they use and their treament of sensitive information
can be seen as a different kind of defense against the violation of privacy that is fingerprinting.

\section{Motivation}
There is a fair amount of related work on the topic. In the fields of privacy and security research,
we always deal with some form of `adversary', meaning something or someone that can change and adapt to new
research and methods. It is therefore important to keep up with any changes, which can happen very quickly
in the context of software.
We aim to analyse the current state of fingerprinting, and contribute to keeping up with modern privacy-violating
techniques.

Tracking a user does not simply mean recognizing whether a visitor to one's website is a new or an existing user.
Identifying information can be passed on or sold to partners, advertisers, or even governments, in order to
construct a rich browsing history of a user. Users are required by EU law to be informed of cookies being set
by websites, yet fingerprinting can and does happen quietly.\footnote{\url{http://ec.europa.eu/ipg/basics/legal/cookies/index\_en.htm\#section\_2} Visited on May 3, 2018}
Our aim is to create more transparency about the websites that users visit.

\section{Fundamentals}
The following section will explain some fundamental knowledge that is
referenced throughout this thesis.

\subsection{Fingerprint}
\label{fundamentals:fingerprint}
Throughout the thesis, terms such as ``fingerprint'', ``browser fingerprint'', etc.
will be used largely interchangeably.
A fingerprint, in most contexts, is something that can uniquely identify something else.
The obvious example is a human's fingerprint, which is unique to each finger of each human,
with very few exceptions, if any.\footnote{\url{https://www.interpol.int/INTERPOL-expertise/Forensics/Fingerprints}}

\subsection{Entropy}
\label{fundamentals:entropy}
Entropy is the most important aspect of a fingerprint.
Peter Eckersley describes entropy as
``a mathematical quantity which allows us to measure how close a fact comes to revealing somebody's identity uniquely''.\footnote{\url{https://www.eff.org/deeplinks/2010/01/primer-information-theory-and-privacy}}
Entropy is often measured in bits, because it measures the different
possible values something can take.
To give an example, the outcome of a coin toss has one bit of entropy,
as it can have two different values: heads or tails.
A random, unknown human's identity contains about 33 bits of entropy,
as two to the power of 33 is 8 billion, and there are some 7.6 billion humans
alive at the time of writing.
If a browser fingerprint can provide 33 bits of information, it can be used
to uniquely identify any person, so long as all fingerprints are unique.

\subsection{JavaScript}
\label{fundamentals:javascript}
JavaScript\footnote{\url{https://developer.mozilla.org/en-US/docs/Web/JavaScript}} is,
at the time of writing, the primary programming language understood
by modern web browsers. While HTML and CSS dictate the visual layout and style
of a web page, JavaScript provides its functionality.
JavaScript is important in the context of this thesis, because
it can be used to construct a browser fingerprint. It can query
the attributes of a browser or device, transform them, and transmit them
to a third party.
Within this thesis, the JavaScript code executed by websites
when visited, will be saved and analysed.
This constitutes the primary source of data for the thesis.

\subsubsection{Obfuscation}
\label{fundamentals:obfuscation}
JavaScript source code can be obfuscated. Obfuscation means to change the code
until it is no longer possible for a human to read the code, at least not within
a reasonable time frame. We have encountered many instances of obfuscated JavaScript
code. For an example of JavaScript obfuscation, consider the code samples in
Figure~\ref{code:javascript_hello_world} and Figure~\ref{code:javascript_obfuscated}.
They are functionally equivalent. The code in Figure~\ref{code:javascript_obfuscated}
has been obfuscated by JavaScript Obfuscator\footnote{\url{https://javascriptobfuscator.com}}.
A more extreme example for obfuscation of JavaScript code is provided by JSFuck\footnote{\url{https://jsfuck.com}},
the output of which cotains only six distinct characters, while still being technically valid JavaScript.

\begin{figure}
\centering
\begin{minted}{javascript}
alert('Hello, world!');
\end{minted}
\caption{A JavaScript ``Hello, World'' program}
\label{code:javascript_hello_world}
\end{figure}

\begin{figure}
\centering
\begin{minted}{javascript}
var _0xd533 = [
    "\x48\x65\x6C\x6C\x6F\x2C\x20\x77\x6F\x72\x6C\x64\x21"
];
alert(_0xd533[0]);
\end{minted}
\caption{An obfuscated JavaScript ``Hello, World'' program}
\label{code:javascript_obfuscated}
\end{figure}

\subsection{Canvas}
\label{fundamentals:canvas}
The canvas \cite{w3ccanvas} is a HTML5 element upon which a web page can draw,
using one of several methods. For instance, WebGL allows rendering of complex
3D graphics on a canvas.
The canvas can also be manipulated by JavaScript. For this thesis,
the canvas plays an important role. It enables the generation
of images with high entropy values in regards to their fingerprinting value.
We will show that many websites draw on a canvas, extract the resultant raw pixel
values from the canvas, and use it to contribute to the generation of a fingerprint.
This is possible for a number of reasons. For one, a JavaScript program
can instruct the browser it is running in to draw emoji on a canvas.
If the browser supports emoji, they will be drawn in a certain way, usually dictated
by the device the browser is running on. Apple's emoji look different from Google's
emoji, for instance.\footnote{\url{https://emojipedia.org/apple/}}\footnote{\url{https://emojipedia.org/google/}}
If emoji are not supported, fallback behavior often means that black squares will
be drawn in their place.
Thus, drawing simple emoji on a canvas can give up information about a device's vendor.
A similar approach can be taken with fonts.
Creating a WebGL rendering context and rendering images on it can reveal
information about the GPU and associated driver software of the host device.


\section{Goal and Leading Questions}
\label{sec:goal}
The overall goal of this thesis is to create a software that can reliably report whether a website carries out
fingerprinting, and to integrate it into PrivacyScore. To achieve this goal,
we must inspect the state of browser fingerprinting across the web, and gain new insights into the topic.
To this end, we will attempt to answer the following leading questions.

\textit{1. What are the most commonly used fingerprinting techniques and how can they be identified by our software?}\\
Identifying the most common techniques is important, as it will allow the detection of the broadest spectrum
of fingerprinters. What are they, and how can we best identify them?

\textit{2. How can false positives and false negatives be minimized?}\\
False positives are, in our case, websites which we identify as fingerprinters, but which do not actually
perform fingerprinting. False negatives, conversely, are sites that do construct fingerprints, but which we
label as non-fingerprinters.
Both are detrimental to the results of the software and thus must be minimized.

\textit{3. How do multiple different fingerprinting techniques relate?}\\
We assume that a service provider is more likely to use more than one fingerprinting technique,
and that the majority of fingerprinters also use the highest amount of different techniques.
Is this the case? Which techniques are most often used together? Why?


% \subsection{What are the most commonly used fingerprinting methodologies?}
% Methods to fingerprint change. Flash, for example, can be used to construct a fingerprint, but is expected
% to be used less and less, since its end of life has been announced.
% So, what are the most-used methods \textit{today}, and how much will these change over time? Which methods
% can be expected to still be used in a year, and which will be deprecated soon?
%
% \subsection{What are the most commonly used fingerprinting libraries and how can they be found?}
% Perhaps the most used library is a closed-source, proprietary product by some large conglomerate,
% with no publicly available information. If its use can be reliably recognized, many websites could be found guilty
% almost immediately. This, however, isn't a given, and it may take considerable effort to answer this question.
%
% \subsection{How can false positives be minimized?}
% False positives, i.e. websites that are identified as fingerprinters, but don't actually employ any such technology,
% are detrimental to the overall results of the software. How can they be minimized or, ideally, eliminated?
%
% \subsection{What does a good/fair metric look like?}
% The impact of false positives can be diminished by employing a rating system or metric to rate a website's
% ``fingerprinting score''. Instead of reporting boolean results (true or false), the software should
% report a number or score that represents the likelihood of fingerprinting taking place, as determined by the software.
% How is such a score calculated, and which attributes are used in this calculation?
%
% \subsection{Can all this be achieved with acceptable performance?}
% This is as much a leading question as it is a goal: the software \textit{must} exhibit adequate performance.
% Since a key component of the stated goal is to integrate the software into \url{https://privacyscore.org},
% it must be able to analyse a website within seconds, to allow acceptable performance of PrivacyScore itself.
% If the software were designed to simply be run once for some large number of websites, so that the results
% could be displayed, it would be fine if it took some arbitrary amount of time. But in order to be useful
% in the desired context, it is imperative that performance is at least something to be kept in mind.

\section{Organization}
The structure of this thesis is shown in the following.
In Chapter~\ref{chap:related_work}, we present related work, split into two main groups:
related work on the topic of browser fingerprinting and related work on
browser fingerprinting detection.
Chapter~\ref{chap:data_acquisition} will showcase our data acquisition
methods and discuss our analyses and their results.
In Chapter~\ref{chap:implementation}, we will give a technical overview of PrivacyScore,
our algorithm, and the integration of our algorithm into PrivacyScore.
We will describe and discuss our scoring algorithm.
Finally, in Chapter~\ref{chap:conclusion}, we will summarize our work and discuss possible future works.

% \section{Methods and Approach}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter End                                                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter Start                                                            %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Related Work}
\label{chap:related_work}
This chapter will give an overview of previous works. It is split into two sections.
The first section presents existing work on the topic of fingerprinting. The second one will show existing work on
the detection of fingerprinting.

\section{Browser Fingerprinting}
There are various closed-source implementations of browser/device fingerprinting. These are unavailable to us.
However, we can turn to several open-source projects which implement fingerprinting for deeper insights into this technology,
and to learn how we may be able to identify the closed implementations.

Essentially, fingerprinting works by combining data available to front-end JavaScript code into a string,
usually by hashing some data structures. This string is the fingerprint.
Different fingerprinting methods can be distinguished by the different attributes they use to construct their fingerprint.

For instance, one of the attributes providing the most entropy is acquired by canvas fingerprinting, which works by drawing
several symbols like geometric shapes, emoji, and so on, on an HTML5 canvas element \cite{laperdrix2016beauty},
as described in more detail in Section~\ref{fundamentals:canvas}
The script in Appendix~\ref{app:canvas_fp} shows an example of canvas fingerprinting.

For a concrete example, \textit{Am I Unique?} writes the same pangram\footnote{A sentence containing every letter of the alphabet.}
twice onto the canvas, using two different fonts, and each time followed by a special Unicode character, an emoji.
Finally, a rectangle in a specific color is drawn \cite{laperdrix2016beauty}.

So, while different fingerprinting scripts are all likely to use canvas fingerprinting, they can differ in the exact
method they use to create the canvas-related aspect of the fingerprint.

The methods described in this section can shed some light onto the different attributes used, and their computation,
and how much entropy each can contribute to a fingerprint.
We have compiled an overview of which attributes are used by which implementation in Table~\ref{table:attributes_used}.


\subsection{Am I Unique?}
\label{related_work:am_i_unique}
\textit{Am I Unique?} \cite{laperdrix2016beauty} is a web service which creates
a fingerprint with the press of a button.\footnote{\url{https://amiunique.org}}
Its purpose is to educate users about fingerprinting.
\textit{Am I Unique?} borrows part of its JavaScript fingerprinting code from
Fingerprintjs2, which is discussed in Section~\ref{related_work:fingerprintjs2}.\footnote{\url{https://github.com/DIVERSIFY-project/amiunique/blob/master/website/public/javascripts/webGL.js\#L2}}


% FIXME there's a new version of Panopticlick that was released after the paper. Does it include canvas fingerprinting?
\subsection{Panopticlick}
\label{related_work:panopticlick}
The EFF's Panopticlick project is similar to \textit{Am I Unique?}, in that it aims to learn and inform about
fingerprinting. It also offers a way to test any tracking protection a user may have enabled by simulating
tracking domains \cite{panopticlick}. The attributes used by Panopticlick to construct a fingerprint differ slightly from those used by
\textit{Am I Unique?}, though overall, they are similar.

Eckersley showed that the list of installed fonts and the list of installed plugins are the most identifying properties
\cite{eckersley2010unique}. This finding, however, did not yet take canvas fingerprinting into consideration.


\subsection{Fingerprintjs2}
\label{related_work:fingerprintjs2}
Fingerprintjs2 \cite{fingerprintjs2} is a popular JavaScript library that
can be used to easily construct a fingerprint.\footnote{4891 stars and 712 forks on GitHub. Visited on February 4, 2018}
It can use a larger variety of attributes when compared to the two previously mentioned services by default.
Which attributes are used to construct the fingerprint can be configured.

In Chapter~\ref{chap:data_acquisition}, we will show that about 7\% of sites we have analysed use Fingerprintjs2.

\renewcommand{\arraystretch}{1.2}
\begin{table}
\centering
\caption{Different Browser Attributes used by Fingerprinting Projects}
\begin{tabular}{ l c c c }
    \toprule
    Attribute & Am I Unique? & Panopticlick & Fingerprintjs2 \\
    \midrule
    User Agent & \cmark & \cmark & \cmark \\[3px]
    Accept Header & \cmark & \cmark & \xmark \\[3px]
    Content Encoding & \cmark & \xmark & \xmark \\[3px]
    Content Language & \cmark & \xmark & \xmark \\[3px]
    List of plugins & \cmark & \cmark & \cmark \\[3px]
    Cookies enabled? & \cmark & \cmark & \xmark \\[3px]
    Local storage available? & \cmark & \xmark & \cmark \\[3px]
    Session storage available? & \cmark & \xmark & \cmark \\[3px]
    Timezone & \cmark & \cmark & \cmark \\[3px]
    Screen resolution & \cmark & \cmark & \cmark \\[3px]
    Screen color depth & \cmark & \cmark & \cmark \\[3px]
    List of fonts & \cmark & \cmark & \cmark \\[3px]
    List of HTTP headers & \cmark & \xmark & \xmark \\[3px]
    Platform & \cmark & \cmark & \cmark \\[3px]
    Do Not Track Header present? & \cmark & \cmark & \cmark \\[3px]
    Canvas & \cmark & \cmark & \cmark \\[3px]
    WebGL & \cmark & \cmark & \cmark \\[3px]
    WebGL Vendor & \cmark & \xmark & \cmark \\[3px]
    WebGL Renderer & \cmark & \cmark & \cmark \\[3px]
    Use of an ad blocker & \cmark & \xmark & \cmark \\[3px]
    JavaScript allowed? & \xmark & \cmark & \xmark \\[3px]
    System Language & \xmark & \cmark & \cmark \\[3px]
    Touchscreen support & \xmark & \cmark & \cmark \\[3px]
    IndexedDB available? & \xmark & \xmark & \cmark \\[3px]
    Open DB? & \xmark & \xmark & \cmark \\[3px]
    CPU class & \xmark & \xmark & \cmark \\[3px]
    Available processors & \xmark & \xmark & \cmark \\[3px]
    Device memory & \xmark & \xmark & \cmark \\[3px]
    \bottomrule
\end{tabular}
\label{table:attributes_used}
\end{table}



\subsection{Fingerprint Central}
\label{related_work:fp_central}
Fingerprint Central, or FP Central, is a website which ``aims at studying the diversity
of browser fingerprints and providing developers with data to help them design good defenses''.\footnote{\url{https://fpcentral.tbb.torproject.org/}}
Much like Panopticlick or \textit{Am I Unique?}, one can have the site generate a device fingerprint,
and view the exact components of the fingerprint, as well as statistics about other users' fingerprints.
Of note is the fact that FP Central does not use canvas fingerprinting at this time.
However, the service is still in its beta phase, so this may change in the future.
Another interesting aspect of FP Central is the math fingerprinting.
High-precision mathematical functions can have operating system specific behavior, and thus provide
entropy.\footnote{\url{https://trac.torproject.org/projects/tor/ticket/13018}}
FP Central also performs audio context fingerprinting, which is also not present in any of the previously presented
fingerprinters.

\subsection{Study by Friedrich-Alexander-University}
The Chair for Computer Science 1 of Friedrich-Alexander-University Erlangen-Nürnberg (FAU)
is, at the time of writing, conducting a study about
browser fingerprinting.\footnote{\url{https://browser-fingerprint.cs.fau.de/}}
Their study has users sign up on their website, and then has users click links
sent to them via email on a weekly basis. Upon visiting each link, a fingerprint of that user is
generated and saved.

Their intermediate results show that 96\% of their 33,302 collected fingerprints are
unique.\footnote{\url{https://browser-fingerprint.cs.fau.de/statistics/} Visited on May 5, 2018}
These fingerprints were generated for 2197 registered participants during 43.2 weeks so far.
One very interesting takeaway from their intermediate results is that 69\%
of all \textit{userAgent} strings are unique amongst their participants.
This makes the \textit{userAgent} a prime attribute to include in a fingerprint,
and can be used by us in our implementation; for a website where the fingerprinting detection
is otherwise inconclusive, the use of the \textit{userAgent} can be the deciding factor.

Their fingerprint seems to include browser and operating system, whether cookies, do-not-track,
JavaScript, Flash, Java and/or Silverlight are enabled, number of plugins, number of MIME types,
and the number of installed fonts. This is based on the information on their statistics page.
A detailed description of their fingerprinting technique is absent on their website.

\section{Browser Fingerprinting Detection}
At a basic level, in order to detect fingerprinting, all JavaScript calls to the relevant attributes,
like User Agent, HTML5CanvasElement, and so on, need to be recorded. Then, a decision can be made about whether the number
of calls is suspicious, or constitutes normal website behavior.

However, since these attributes also have legitimate uses, this is not a trivial task.
This section will present previous work on this topic.


\subsection{FPDetective}
\label{related_work:fpdetective}
Acar et al. provide some useful metrics to differentiate between fingerprinting and legitimate use of
browser attributes \cite{DBLP:conf/ccs/AcarJNDGPP13}. They have implemented a fingerprinting-detection
framework called \textit{FPDetective}.
\textit{FPDetective} focuses on font-based fingerprinting, and uses
\textit{PhantomJS} to log JavaScript function calls and \textit{Chromium} to log Flash actions.
Much like OpenWPM, their crawler logs accesses to certain browser and device properties, such as
those contained within the \textit{window.navigator} object.
Popular attributes like the HTML5 Canvas and WebGL were ignored in the study and by the framework's logging.

Partly automated, their process consisted of an automated analysis in regards to font fingerprinting,
and a manual analysis of JavaScript and decompiled Flash code.
Their focus on fonts derives from the assumption that a website that
enumerates fonts is a likely fingerprinter.

\textit{FPDetective} classifies a script as a fingerprinter if ``it loads more than 30 system fonts, enumerates plugins
or mimeTypes, detects screen and navigator properties, and sends the collected data back to a remote server''
\cite{DBLP:conf/ccs/AcarJNDGPP13}.
In Chapter~\ref{todo}, we show that this metric is \todo{accurate/useful or not?}.

As Flash is nearing its end-of-life, this thesis opts not to analyse Flash programs
delivered by websites, which means \textit{FPDetective}'s extensive work on Flash-based fingerprinting
is of little use for us.


\subsection{OpenWPM}
\label{section:openwpm}
Englehardt et al. have developed a framework called \textit{OpenWPM}, which can be used to analyse the way a website
handles users' privacy. They have used this to analyse the tracking behavior of one million websites
\cite{DBLP:conf/ccs/EnglehardtN16,englehardt2016census}.

Englehardt et al. differentiate between distinct forms of fingerprinting.
They classify a script as a canvas-fingerprinter, if there is a canvas larger than 16 by 16 pixels, and text is
written to it in either at least two different colors, or with 10 distinct characters.
A canvas-fingerprinter script should not call the \textit{save}, \textit{restore} or \textit{addEventListener}
methods of the rendering context.
\dominik{Deine Notiz: `should or should not? and: why? how did they justify that?'}\\
\dominik{\textit{should not}, und sie haben es nicht justified... vermutlich aber weil die genannten Methoden legitimen Nutzen wahrscheinlicher machen? ich als fingerprinter kann denen also ausweichen, indem ich einfach diese Methoden benutze...}

Finally, the script has to call either \textit{toDataURL}
or \textit{getImageData} for an area of at least 16 pixels in width and height.
They have manually verified the accuracy of their heuristic, and found only four false positives
out of 3493 scripts.
We will show that this heuristic is \todo{good/not good?}.

Englehardt et al. make a distinction between canvas fingerprinting and canvas font fingerprinting.
They classify a script as a canvas font fingerprinter if it sets the \textit{font} property
of a canvas at least 50 times, and also calls the \textit{measureText} method at least 50 times.
They have manually verified that there were no false positives for this metric.

Their findings show that only about 1.6\% of the analysed sites
employ canvas-based fingerprinting. However, they also show that among the top 1,000 sites,
5.1\% of sites employ canvas-based fingerprinting.

Their work also examines new, previously unknown methods of fingerprinting, such as canvas font fingerprinting, which
works by rendering text in a large number of different fonts on a canvas element; WebRTC-based fingerprinting, which,
as the name suggests, abuses the WebRTC framework; as well as AudioContext fingerprinting, and Battery API fingerprinting.

OpenWPM uses Firefox, Selenium, and custom JavaScript injected into loaded sites to log calls to relevant browser attributes.
It constitutes the technological basis of this thesis' work, as it allows easy crawling of websites, while recording
most if not all relevant information.


\subsection{Tor Browser}
\label{related_work:tor_browser}
\textit{The Design and Implementation of the Tor Browser [DRAFT]}
states that ``[the authors] believe that the HTML5 Canvas is the single largest fingerprinting threat browsers face today'',
as a canvas offers easy and high-entropy fingerprinting
\cite{acar2014web,mowery2012pixel,torbrowser2018design}.
The Tor Browser can alert users to data collection from a HTML5 Canvas element.
Data collection, in this context, means using a function like \textit{toDataURL} or \textit{measureText} on the element.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter End                                                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter Start                                                            %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Data Acquisition and Analysis}
\label{chap:data_acquisition}
This chapter presents the data set used to conduct the experiments used in this thesis.
We will describe how the data was acquired, and present an analysis of the fingerprinting
behavior contained within.

Our goal is to base a scoring algorithm on our findings, which we will integrate into PrivacyScore.
A good scoring algorithm will distinguish at least three cases. That a site is very likely fingerprinting,
that a site is very likely not fingerprinting, or that there is insufficient data to make a meaningful decision.
PrivacyScore has a rating system that distinguishes between the values
\textit{critical}, \textit{bad}, \textit{warning}, \textit{neutral}, \textit{good},
and \textit{doubleplusgood}.\footnote{\url{https://github.com/PrivacyScore/PrivacyScore/blob/master/privacyscore/evaluation/rating.py\#L11} Visited on May 3, 2018}
Our scoring algorithm will need to map its results to these ratings. Obviously, a site that uses no fingerprintable
attributes or APIs will get a \textit{doubleplusgood} rating; the more attributes and APIs are used, the lower the rating.
We will present our algorithm in Chapter~\ref{chap:implementation}.

\section{Acquiring Site Information}
\label{sec:acquiring_information}
As described in Section~\ref{section:openwpm}, we have used OpenWPM\footnote{\url{https://github.com/citp/OpenWPM}} to gather data about
website behavior.
The parameters used with OpenWPM to gather the data can be found in Appendix~\ref{app:params}.

OpenWPM saves most data in SQLite3 databases.\footnote{\url{https://www.sqlite.org/index.html}}
This includes the data interesting to us: JavaScript calls, function names, and script URLs.
We analysed the SQLite3 databases using Python3 scripts.
Physical distributions of this thesis include the source code on a CD-ROM.
We will show some of the SQL queries we used to extract interesting data throughout Chapter~\ref{chap:data_acquisition}.

Alexa regularly compiles a list of the top one million websites, ordered by the number of
visitors.\footnote{\url{https://www.alexa.com/topsites}}
We have analysed the top 5000 websites, as described by a version of this list acquired from
\url{http://s3.amazonaws.com/alexa-static/top-1m.csv.zip} on December 19, 2017.

Multiple data sets based on this list were gathered. Due to timeouts or other
errors, not all 5000 sites were actually crawled each time.
The primary data set we used was crawled on January 27, 2018, and includes 4929 sites with distinct URLs. Some of these sites
may be duplicates of each other. For instance, the URL \url{https://fbcdn.net/} for Facebook's content delivery
network simply points to \url{https://facebook.com/}, both of which are included in the data set.

We make the distinction between the primary data set and secondary data sets.
We have run all analyses on the primary data set, and we will show
that the noted behavior is consistent by repeating some analyses
on the secondary sets.
We do this because running all analyses on all sets is beyond the time
constraints of this work.
In the following, we will refer to the primary data set as simply ``the data set''.

\section{Data Properties}
\label{section:data_properties}
In this section, we will give an overview of basic properties of the primary data set,
with special regard to their relevance for fingerprinting.
Table~\ref{table:dataprops} shows some of these properties.

\renewcommand{\arraystretch}{1.2}
\begin{table}
\centering
\caption{Behavior of Analysed Websites}
\begin{tabular}{l r r}
    \toprule
% \arrayrulecolor{hlinegray}
    & amount & percentage \\
    \textbf{All sites} & 4929 & 100\% \\
    \midrule
    \textbf{Basic attribute lookups} & & \\
    userAgent & 4424 & 90\% \\ %89.8
    language or languages & 3985 & 81\% \\ %80.8
    colorDepth & 3931 & 80\% \\ %79.8
    localStorage & 3772 & 77\% \\
    platform & 3275 & 66\% \\ %66.4
    sessionStorage & 2860 & 58\% \\
    cookieEnabled & 2823 & 57\% \\ %57.3
    doNotTrack & 1406 & 29\% \\ %28.5
    oscpu & 580 & 12\% \\ %11.8
    \midrule
    \textbf{Using multiple of above attributes} & & \\
    at least 2 & 4338 & 88\% \\
    at least 3 & 4245 & 86\% \\
    at least 4 & 3968 & 81\% \\
    at least 5 & 3572 & 72\% \\
    at least 6 & 2906 & 59\% \\
    at least 7 & 1963 & 40\% \\
    at least 8 & 1138 & 23\% \\
    9 attributes & 473 & 10\% \\
    \midrule
    \textbf{Canvas-related functions or attributes} & & \\
    Using any Canvas-related JavaScript & 1657 & 34\% \\ %33.6
    toDataURL or getImageData & 884 & 18\% \\ %17.9
    toDataURL & 768 & 16\% \\ %15.6
    getImageData & 252 & 5\% \\ %5.1
    \midrule
    Calling functions defined by \textit{Fingerprintjs2} & 336 & 7\% \\ %6.8
    \bottomrule
\end{tabular}
\label{table:dataprops}
\end{table}

The first block of Table~\ref{table:dataprops}, titled \textit{Basic attribute lookups},
shows how many sites looked up certain browser or device attributes.
We label these as ``basic'', because a JavaScript program can access them with a single function
call. In this section of the table, we can see that, for example, 90\% of sites in the set access the
\textit{userAgent} property.
How many websites access which attribute is interesting to us because of the basic attributes' ease of access.
As their values are easy to acquire, one might expect that these attributes are consistently used by different fingerprinters.

The next section in the table shows how many sites use more than one of the basic attributes.
Note that the rows are not mutually exclusive. This means that, e.g. the 4245 sites using ``at least'' three
attributes also contain all sites that use more than three attributes.
This information is useful, because fingerprints are usually constructed from
multiple data points, so that they are sufficiently unique \cite{panopticlick}.

The final block of Table~\ref{table:dataprops} is focused on the HTML5 Canvas element.
More specifically, we show how many sites use any kind of Canvas-related JavaScript,
as well as how many use the specific data extraction methods.
A website qualifies as using ``any Canvas-related JavaScript'' when it makes use
of any function calls that are part of the Canvas API.\footnote{\url{https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API}}
The two methods that can be used for data extraction are
\textit{toDataURL}\footnote{\url{https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toDataURL}}
and
\textit{getImageData}\footnote{\url{{https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/getImageData}}}.
This part of the table is of interest, because the Canvas element is one of the
most useful elements for the construction of a fingerprint (cf. Sec.~\ref{fundamentals:canvas}).

Of the 884 sites that use \textit{toDataURL} or \textit{getImageData} on a HTML5 Canvas object, which suggests
a high likelihood of canvas fingerprinting, 536, or about 61\%, also use eight or more of the basic attributes.
These 536 sites (not shown in the table) are good candidates for likely fingerprinters.
And indeed, 147 of them are contained in the 336 sites that we have identified as users of \textit{Fingerprintjs2}.
\textit{Fingerprintjs2}, as discussed in Section~\ref{related_work:fingerprintjs2},
can be configured to include any number of attributes
in its generated fingerprint.

From the above, we can also conclude that 189 users of \textit{Fingerprintjs2}
do not use either of the data extraction methods of the Canvas element. This is curious because
of the high entropy of the Canvas fingerprinting technique.
The cause for this could be that the sites are trying to avoid detection, or that they
do not want to alert their users. The Tor Browser can alert users when a site is trying
to extract data from a canvas (cf. Sect.~\ref{related_work:tor_browser}).

The number of users of Fingerprintjs2 was found by simply querying the database for function names that are consistent with
those used in Fingerprintjs2, and therefore do not include sites which use an obfuscated Fingerprintjs2.
Fingerprintjs2 has a few functions starting with the prefix \textit{getHasLied}, like \textit{getHasLiedOs}, the purpose
of which is to report whether a browser tampered with certain information, for instance in the interest of mitigating
fingerprinting.\footnote{\url{https://github.com/Valve/fingerprintjs2/wiki/Browser-tampering} Visited on February 8, 2018}
Due to the peculiar name choice, and the fact that the same sites that call one \textit{getHasLied}
function also call all others, we can be quite certain that they all include Fingerprintjs2.


\section{\textit{toDataURL} Usage}
\label{sec:todataurl}
In Section~\ref{section:data_properties} we suggested that a use of \textit{toDataURL}
suggests a high likelihood of canvas fingerprinting.
To show the plausibility of this claim, we have performed a manual analysis of the scripts served by
75 sites that use \textit{toDataURL}.
These 75 sites were randomly sampled from the list of sites which call \textit{toDataURL},
but have not been identified as users of FingerprintJS2. We exclude users of Fingerprintjs2,
as they would not provide any further insights, and we already have a good estimate
of how many sites in our dataset use it, as shown in Table~\ref{table:dataprops}.

\begin{figure}
\centering
\begin{minted}{sql}
SELECT DISTINCT script_url
FROM javascript
WHERE symbol = 'HTMLCanvasElement.toDataURL';
\end{minted}
\caption{SQL query to select all JavaScript programs using \textit{toDataURL}.}
\label{code:todataurl_users_query}
\end{figure}

OpenWPM gives us a SQLite database, which includes a \textit{javascript} table.
This table includes a column called \textit{script\_url}, which contains
the URL to a JavaScript file, and a column called \textit{symbol}, containing
the name of the symbol accessed by a JavaScript program.
Using the query depicted in Figure~\ref{code:todataurl_users_query}, we can find all scripts
that access the symbol \textit{HTMLCanvasElement.toDataURL}.

The analysis of these scripts was done by looking for tell-tale signs of fingerprinting
in the (potentially minified) JavaScript code.
These signs are enumeration of fonts, writing to canvases, never displaying canvases,
enumeration of plugins, and suspicious function names like \textit{getFingerprint}.

Following the analysis, we claim with confidence that 51 out of the 75 sites are fingerprinters.
Table~\ref{table:todataurl_users} shows more details of this analysis.

\begin{table}
\centering
\caption{Behavior of \textit{toDataURL} Users}
\begin{tabular}{l r r}
    \toprule
    & amount & percentage \\
    \midrule
    \textbf{analysed sites} & 75 & 100\% \\
    \midrule
    \textbf{Fingerprinting sites} & 51 & 67\% \\
    Using a popular third-party script & 26 & 34\% \\
    Using functions with suspicious name & 11 & 15\% \\
    Using a popular pangram on canvas & 4 & 5\% \\
    \midrule
    \textbf{Inconclusive} & 16 & 21\% \\
    \midrule
    \textbf{Legitimate users} & 9 & 12\% \\
    Emoji-detection & 7 & 9\% \\
    Applying blur to image & 1 & 1\% \\
    Lazily loading an image & 1 & 1\% \\
    \bottomrule
\end{tabular}
\label{table:todataurl_users}
\end{table}

The first block of Table~\ref{table:todataurl_users} shows the sites
we have deemed to be fingerprinters. Of these, 26 use a popular third-party script.
This is interesting, because the behavior of widely used scripts can be used to tune our scoring system.
However, when assigning a score, looking for suspicious scripts based on
name or URL alone, is not practical. This is because a fingerprinter
can hide this from us easily, if they wanted to.
One way to hide a script is to obfuscate it instead of simply minifying.
Another way to hide its origin is to serve it as a first-party script,
not a third-party script, and replacing its name in a URL with random
letters or words.

The block showing the fingerprinting sites also shows that 11 of them
use a suspicious name for a function. To give some examples:
\textit{getCanvasFp}, \textit{getCanvasPrint}, \textit{canvasFingerprint}.
We assume that any function would not be named in such a way if it did not
indeed perform fingerprinting.
The scripts using the suspicious names additionally showed other behavior
exhibiting the signs of fingerprinting.
Looking for suspicious function names while scoring should be avoided,
as adversaries can simply change the function names to avoid or
limit detection, as many scripts already do through obfuscation.

% Cwm fjordbank glyphs vext quiz, 😃
\begin{figure}
\centering
\includegraphics[scale=0.3]{images/fjordbank.png}
\caption{Pangram with emoji as used by \textit{Am I Unique?}, among others}
\label{code:pangram}
\end{figure}

Four of the found fingerprinters used the popular pangram shown in
Figure~\ref{code:pangram} to perform canvas fingerprinting.
Unfortunately, this is not useful in scoring future fingerprinters,
as they can easily change the pangram they use.

We label sixteen of the \textit{toDataURL} users as inconclusive.
Their JavaScript was too obfuscated to draw meaningful conclusions.
While obfuscation may itself be suspicious, many sites could perform
it simply to keep their codebase closed-source.

The final block of Table~\ref{table:todataurl_users} shows sites which
made ``legitimate'' use of \textit{toDataURL}. Seven sites used a canvas
to detect how well emoji were supported. This is done by drawing emoji
to a canvas, and analysing the array returned from \textit{toDataURL}.
If emoji are not supported by the system, they will be drawn as black
squares or other non-emoji symbols.

One site used \textit{toDataURL} seemingly to apply blur to an image.
The final entry in Table~\ref{table:todataurl_users} shows one site
using a JavaScript module or library seemingly called ``lazyimage''
to lazily load an image. This means to include a placeholder
image on the site, and only load the actual image when needed.


\section{Audio Fingerprinting}
The distinct JavaScript interfaces related to audio present in our data set,
as recorded by OpenWPM, are:
\textit{AudioContext},
\textit{OfflineAudioContext},
\textit{AnalyserNode},
\textit{GainNode} and \textit{ScriptProcessorNode}.\footnote{See also: \url{https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API}}

\begin{figure}
\begin{minted}{sql}
SELECT DISTINCT site_visits.site_url
FROM site_visits
  JOIN javascript
    ON site_visits.visit_id = javascript.visit_id
WHERE javascript.symbol LIKE '%audio%'
   OR javascript.symbol LIKE 'AnalyserNode%'
   OR javascript.symbol LIKE 'GainNode%'
   OR javascript.symbol LIKE 'OscillatorNode%'
   OR javascript.symbol LIKE 'ScriptProcessorNode%';
\end{minted}
\caption{Query to select all users of audio-related JavaScript calls}
\label{code:audio_query}
\end{figure}

\begin{table}
\centering
\caption{Behavior of Audio API Users}
\begin{tabular}{l r r}
    \toprule
    & amount & percentage \\
    \midrule
    \textbf{analysed sites} & 64 & 100\% \\
    \midrule
    \textbf{Fingerprinting sites} & 46 & 72\% \\
    PerimeterX script users & 15 & 23\% \\
    Facebook script users & 13 & 20\% \\
    \midrule
    \textbf{Inconclusive} & 17 & 27\% \\
    users of too obfuscated b2c script & 11 & 17\% \\
    otherwise too obfuscated & 5 & 8\% \\
    otherwise inconclusive & 1 & 2\% \\
    \midrule
    \textbf{Legitimate users} & 1 & 2\% \\
    \bottomrule
\end{tabular}
\label{table:audio_users}
\end{table}

The SQL query in Figure~\ref{code:audio_query} selects all sites that
use a JavaScript interface or symbol related to audio.
It returns 64 rows when executed on our data set, meaning there are 64 potential audio
fingerprinters, which represents about $1.2\%$ of our set.
We have performed a manual analysis of these sites in regards to audio
fingerprinting similar to the one we have performed for \textit{toDataURL}.
The results are displayed in Table~\ref{table:audio_users}.

The most important takeaway from Table~\ref{table:audio_users} could be that we were
able to find just one legitimate use of the JavaScript Audio API.
``Legitimate'' in this case means that it is used to generate and play audible sounds
for a visitor to hear.

Given the high amount of ``inconclusive'' entries, we have visited each Audio user labeled as such
in a Chromium web browser, which produces the version string ``Version 65.0.3325.181 (Developer Build) (64-bit)''.
This browser was otherwise unmodified, meaning there were no plugins, such as ad-blockers, installed.
Note that this version of the Chromium web browser supports the Audio API, which we have manually verified
by creating an instance of \textit{AudioContext} in the console of the developer tools.

We have visited each site and waited for it to finish loading completely, and waited a further 10 seconds,
exactly like OpenWPM in our automated data collection.
One of these sites has played audio, although via an embedded YouTube livestream.
This, as far as we could tell, does not use the Audio API.

Thus, we are confident that our data set indeed contains only a single legitimate use of
the Audio API.

Table~\ref{table:audio_users} further shows the use of three prominent, reoccuring scripts, the most used
of which is one provided by PerimeterX\footnote{\url{https://www.perimeterx.com/}}.
PerimeterX offers ``Bot Detection and Anti Bot Protection with Unparalleled Accuracy'',
according to their website's home page. To this end, they seem to construct a browser fingerprint.
Their script accesses numerous properties of the \textit{window.navigator} object, uses \textit{toDataURL},
\textit{WebGL}, the Web Audio API, and enumerates 32 different fonts.

The second most used script originates from Facebook. It can be found under the same URL
for each of the 13 sites in our set which use it.\footnote{\url{https://cdn.atlassbx.com/FB/11122200772940/browser_features1488235112.js}, visited on March 30, 2018}
Along with the Web Audio API, it uses the Canvas API, enumerates 26 distinct fonts and accesses other
properties of the \textit{window} and \textit{window.navigator} objects which are often used in fingerprinting.
We have also found the ``mmmmmmmmmmlli'' magic string in the JavaScript code, which we will further discuss
in Section~\ref{sec:font_fingerprinting}.
Thus, we also classify it as a fingerprinter.

We refer to the final script as ``the b2c script'', although it may in fact be more than one distinct
script. We have observed it to be served from mutliple different URLs,
all beginning with \textit{api.b2c.com/api/init-}, and ending with a mix of letters and numbers and the \textit{.js} extension.
All of these scripts were much too obfuscated to make any sense of. We have thus labeled their behavior ``inconclusive''.
However, we assert that it is very likely that these scripts are indeed fingerprinters.
OpenWPM has recorded 31 distinct symbols being accessed by these ``b2c'' scripts, among them
those related to the Canvas API, Web Audio API, WebGL, \textit{localStorage}, \textit{sessionStorage},
as well as multiple ``basic properties''.

We conclude that the Audio API is a prime indicator of browser fingerprinting, as the instances of
fingerprinting use far outweigh its use of actual audio playback.


\section{Font Fingerprinting}
\label{sec:font_fingerprinting}
Font fingerprinting is easy to recognize when analysing minified JavaScript,
as it works by enumerating various fonts to see if they are available on the fingerprinted
system. This can be done by writing text to a Canvas in various fonts and measuring
the rendered writing using the \textit{measureText} method \cite{englehardt2016census}.

Because of its usual use of the Canvas element, it is closely related to Canvas fingerprinting,
and it can be difficult to classify in some cases. In Section~\ref{sec:todataurl}
we have shown an example of a ``magic string'' pangram, which also contains some emoji.
It is used by \textit{Am I Unique?} and others to fingerprint via the Canvas element.
To that end, it is written onto a canvas in two different fonts, and some other elements are drawn
as well, and the pixel data is then extracted. This method obviously uses font information
to improve the fingerprint.
However, other methods are more font-centric and use many more fonts, as well as the \textit{measureText}
method.
Yet other methods do not use a Canvas element at all.

Font fingerprinting in the form where many fonts are enumerated is easy to spot in minified JavaScript,
as there is usually an array containing many font names present.
For automated scoring, counting how many fonts were set on a Canvas element can reveal Canvas-based
font fingerprinting. For non-Canvas based font enumeration, the property accessors
\textit{offsetWidth} and \textit{offsetHeight} are used, the use of which we can also count.
This is described in greater detail below.

Within the context of Font fingerprinting, we have identified the ``magic string''
\textit{mmmmmmmmmmlli}. To the best of our knowledge, we are the first to notice this string
in relation to fingerprinting. It is used by at least ten sites in our dataset, and always occurs
with exactly ten times the letter ``m'', two times the letter ``l'', and one letter ``i''.

We are unsure about the real number of sites in our dataset that use this magic string, because
it is sometimes used within a \textit{span} element instead of a canvas.
JavaScript calls on this type of element are not instrumented by OpenWPM.
Thus, there may be more sites that use this magic string to fingerprint
in our dataset.
We have included an example of this type of fingerprinting in Figure~\ref{app:mmmmmmmmmmlli}
in the Appendix.
The \textit{mmmmmmmmmmlli} string is also present and used in the source code of Fingerprintjs2,
though, since it is configurable, it does not reveal much more information about how many websites
make use of the string. It does suggest, though, that a large number of websites indeed make use of it.

We assume that the \textit{mmmmmmmmmmlli} string has certain subtle differences in width
when rendered by different browsers or font-rendering libraries on different systems, with
different fonts or font-families. We leave the determintation of the exact reason to use
this particular string for future work.

Nikiforakis, et al. describe an observed font fingerprinting technique that works by setting
a text within a \textit{span} HTML element, and measuring its width and height after setting
different fonts \cite{nikiforakis2013cookieless}. If a measurement for a certain font is different
from that of a default fallback font, the fingerprinter can conclude that that particular font
is installed.

The specific JavaScript methods used are called \textit{offsetWidth} and \textit{offsetHeight},
and are, again, not instrumented by OpenWPM. We have added the required instrumentation into
the OpenWPM instance used by PrivacyScore for our implementation.


\section{WebGL Fingerprinting}

\begin{figure}
\begin{minted}{sql}
SELECT DISTINCT site_url
FROM site_visits
  JOIN javascript
    ON site_visits.visit_id = javascript.visit_id
WHERE symbol LIKE '%getcontext%'
  AND arguments LIKE '%webgl%';
\end{minted}
\caption{Query to select all users of a WebGL context}
\label{code:webgl_query}
\end{figure}

\begin{table}
\centering
\caption{Behavior of WebGL Users}
\begin{tabular}{l r r}
    \toprule
    & amount & percentage \\
    \midrule
    \textbf{analysed sites} & 75 & 100\% \\
    \midrule
    \textbf{Fingerprinting sites} & 34 & 45\% \\
    \midrule
    \textbf{Inconclusive} & 21 & 28\% \\
    too obfuscated & 10 & 13\% \\
    otherwise inconclusive & 11 & 15\% \\
    \midrule
    \textbf{Legitimate users} & 20 & 27\% \\
    \bottomrule
\end{tabular}
\label{table:webgl_users}
\end{table}

The results of our analysis, as displayed in Table~\ref{table:webgl_users}, again show that this
API is used by many fingerprinters in our dataset.
With WebGL, there is a higher number of sites which we have labeled ``inconclusive''.
This is because \todo{warum ist das so? war halt irgendwie schwerer zu erkennen...}

As OpenWPM in its current version does not instrument calls to the WebGL API, we have to
work around this by using the SQL query shown in Figure~\ref{code:webgl_query}.
There are no other symbols that OpenWPM instruments that are related to WebGL.

This also limits our methods of automatically labeling a script a fingerprinter.
The only information we can gather from the database OpenWPM creates
is whether a script creates a WebGL context or not.

\begin{figure}
\begin{minted}{javascript}
var canvas = document.createElement("canvas");
var gl = canvas.getContext("webgl");
db_info = gl.getExtension('WEBGL_debug_renderer_info');
console.log(gl.getParameter(db_info.UNMASKED_VENDOR_WEBGL));
console.log(gl.getParameter(db_info.UNMASKED_RENDERER_WEBGL));
\end{minted}
\null % needed for newline
Example console output:
\begin{verbatim}
NVIDIA Corporation
GeForce GTX 970/PCIe/SSE2
\end{verbatim}
\caption{JavaScript code that reveals GPU model and vendor.}
\label{code:gpu_vendor}
\end{figure}

We have patched OpenWPM to be able to instrument the WebGL API.
Specifically, we can instrument the \textit{WebGLRenderingContext}
object, and have performed another crawl of the top 500 sites of our list (cf. Sec.~\ref{acquiring_information}),
while instrumenting specifically the method \textit{getExtension} of the \textit{WebGLRenderingContext} object.
This method, when given the parameter \textit{WEBGL\_debug\_renderer\_info}, produces another object
which reveals information about the vendor and model of the GPU of the host computer.
This object does not hold any other information, and cannot be used for any purpose other than
finding out the GPU vendor and model.
The code in Figure~\ref{code:gpu_vendor} shows an example of the fingerprintable information
revealed by this object.

Of the 500 sites in the additional crawl, 22 used the method \textit{getExtension} with the parameter
\textit{WEBGL\_debug\_renderer\_info}. Of these 22, eight used Fingerprintjs2 to fingerprint, four
used a script by PerimeterX to fingerprint, five fingerprinted otherwise, and the remaining five
were either too obfuscated or did not fingerprint.

We can conclude that the above behavior that can be used to find out the GPU vendor and model
is a good indicator for fingerprinting, although our results are not based on as strong a dataset
as other results presented by this thesis. Still, we contend that fetching this GPU information
is suspicious enough to warrant a more negative rating in our scoring scheme.


\section{WebRTC Fingerprinting}
\begin{figure}
\begin{minted}{sql}
SELECT DISTINCT site_url
FROM site_visits
  JOIN javascript
    ON site_visits.visit_id = javascript.visit_id
WHERE symbol LIKE 'RTCPeerConnection%';
\end{minted}
\caption{Query to select all users of the WebRTC API}
\label{code:webrtc_query}
\end{figure}

\begin{table}
\centering
\caption{Behavior of WebRTC Users}
\begin{tabular}{l r r}
    \toprule
    & amount & percentage \\
    \midrule
    \textbf{analysed sites} & 75 & 100\% \\
    \midrule
    \textbf{Fingerprinting sites} & 15 & 20\% \\
    \midrule
    \textbf{Inconclusive} & 51 & 68\% \\
    using adsafeprotected script & 37 & 49\% \\
    too obfuscated & 14 & 19\% \\
    otherwise inconclusive & 1 & 1\% \\
    \midrule
    \textbf{Legitimate users} & 9 & 12\% \\
    \bottomrule
\end{tabular}
\label{table:webrtc_users}
\end{table}

Our analysis of WebRTC users shows similar results as our analysis of WebGL users.
Of the 75 sites we have analysed, we have labeled 15 as definite fingerprinters.
Nine sites were labeled as legitimate users of the WebRTC API. The remaining 51 are inconclusive.
Of these 51, 14 were too obfuscated to make sense of, and most, 37, used the same script
served from the URL \url{https://static.adsafeprotected.com/sca.17.4.20.js}.
We believe that this script enumerates browser features, based on many function definitions
which try to access some web API, and return a boolean value representing either success
or failure to access that API.
However, we are not certain that it constructs a fingerprint in the traditional sense.
\todo{Script genauer anschauen; ist schon sehr fingerprinty aber wer weiß}


\section{Multiple Fingerprinting Techniques}
\label{sec:correlation}

\begin{table}
\centering
\caption{Numbers of Fingerprinting APIs Used}
\begin{tabular}{l r r}
    \toprule
    APIs used & amount & percentage \\
    \midrule
    \textbf{analysed sites} & 60 & 100\% \\
    \midrule
    1 & 15 & 25\% \\
    2 & 20 & 33\% \\
    3 & 13 & 22\% \\
    4 & 9 & 15\% \\
    5 & 2 & 3\% \\
    \bottomrule
\end{tabular}
\label{table:multiple_apis}
\end{table}

We assume that a site which was identified to fingerprint using one method is likely
to also be using another method.
This is a reasonable assumption, as more techniques give more entropy, and more entropy makes a more
unique and therefore better fingerprint.

To substantiate our claim, we have analysed 60 sites which we have previously identified as fingerprinters.
These sites were picked randomly from our set of already identified fingerprinters.

We exclude the basic attributes, such as the \textit{userAgent}, when we count the methods used by a site.
The counted methods are thus Audio-, Canvas-, Font-, WebGL- and WebRTC-Fingerprinting.
All analysed sites also used basic attributes to enhance their fingerprint.

The results are shown in Table~\ref{table:multiple_apis}, and support our assumption. A quarter of the fingerprinters
use one API to fingerprint, and the remainder use more than one.
Between one and three APIs used are the most common cases, four and especially five different APIs are much less common.

We conclude that it is not especially rare for a site to use only one fingerprintable API in addition
to the basic browser attributes, but the majority of fingerprinters use more than one such API.


\section{Most Common Techniques}
\begin{table}
\centering
\caption{Extrapolated Frequency of Fingerprinting Techniques}
\begin{tabular}{l c c c}
    \toprule
    & Fingerprinters & Total API Use & Estimated Fingerprinters \\
    \midrule
    Audio & 72\% & 64 & 1\% \\
    Canvas & 67\% & 768 & 10\% \\
    WebGL & 45\% & 438 & 4\% \\
    WebRTC & 20\% & 281 & 1\% \\
    \bottomrule
\end{tabular}
\label{table:technique_frequency}
\end{table}

Based on our findings, we can extrapolate an estimate for the most commonly used fingerprinting
techniques.
Table~\ref{table:technique_frequency} shows basic estimations of the total fingerprinters
for each technqiue. The ``Fingerprinters'' column shows how many sites of the subset
we have analysed for that technique were deemed fingerprinters. The column ``Total API Use''
shows, how many sites in our dataset use the fingerprintable API (in any way).
If we apply the first percentage to the number of that column, we get an estimate
of how many sites in our dataset use this API to fingerprint. The column ``Estimated Fingerprinters''
shows the resulting percentage.

For example, 67\% of the 75 sites that use the Canvas API we have analysed are fingerprinters.
The total number of sites that use the Canvas API in our entire dataset is 768.
That means that the total number of sites that fingerprint with this API in our dataset
can be estimated as $ 67\% \cdot 768 \approx 515  $. 515 sites out of the total 4929
is roughly 10\%. That means we can estimate that 10\% of all sites in our dataset use Canvas
fingerprinting.

We can see that Canvas fingerprinting is by far the most popular, though the Audio API, when used,
is more likely to be used for fingerprinting.
With this, we have answered our first leading question (cf. Sec.~\ref{sec:goal}).


\section{Discussion}
\label{sec:data_discussion}
In the following, we will discuss the acquired data and the analyses we have performed.

\subsection{Fingerprinters}
The data shows us that simply by using a Canvas object a certain way, or by using the Audio API,
a site is already a likely fingerprinter. We can assert this, because our analyses have shown
67\% of analysed users of \textit{toDataURL}, 72\% of analysed Audio API users and 45\%
of analysed users of WebGL to be fingerprinters.
Furthermore, 20\% of WebRTC users fingerprint, in addition to any fingerprinters we were unable
to identify, like the 49\% that use a suspicious but inconclusively labeled script.
Thus, just by using one or more of the listed APIs, we ascertain that a website is more likely
to be a fingerprinter than not.

We have also found certain giveaways of sites being fingerprinters.
The \textit{mmmmmmmmmmlli} magic string is used exclusively by font fingerprinting scripts.
The peculiar text \textit{Cwm fjordbank glyphs vext quiz} followed by an emoji is similarly used only
by fingerprinters.
Oftentimes, fingerprinter scripts contain very suspicious function names, such as \textit{getCanvasFingerprint}.
While the absence of these details does not help in classifying a site,
their presence can be used to instantly classify a site or script as a fingerprinter.


\subsection{Limitations}
When analysing a site, it is difficult or even impossible to tell whether an executed
script sends data back to the site's servers, or a third party.
To give an example, many sites include some kind of ``share'' button,
oftentimes for social media platforms like Facebook or Twitter.
These buttons are not always simply images surrounded by an HTML \textit{a}-tag,
but include JavaScript code as well.
This JavaScript, we assume, communicates with the network which ``owns''
the button, not the site where the button is displayed.
And this JavaScript may be a fingerprinter.

From a user's perspective, however, there may not be much of a difference.
In the end, the user is still getting fingerprinted and tracked, regardless
of who is at fault.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter End                                                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter Start                                                            %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Design and Implementation}
\label{chap:implementation}
In Chapter~\ref{chap:data_acquisition}, we have shown many users of certain JavaScript APIs to be fingerprinters.
We can build upon this knowledge to score websites in regards to their likelihood to be fingerprinting.

Our approach to implement automated fingerprinting detection is described in the following.
The software will analyse the behavior of a website based on a data gathering by OpenWPM.
We will extract all information relevant to fingerprinting from the database,
and present this to the user of the detection software.
We will highlight any giveaways of fingerprinting, such as included magic strings
or suspicious function names.

In Section~\ref{sec:correlation}, we have shown that a fingerprinting site is more
likely to use a variety of fingerprinting methods than it is to use just one.
Thus, the more usage of suspicious APIs we detect, the higher the likelihood
that we have found a fingerprinter.

A site could be labeled more suspicious if many fingerprintable APIs are used within the same script,
and less suspicious if their use is spread across different scripts.
However, a site looking to avoid our detection mechanism could simply
spread their fingerprinting algorithm across multiple JavaScript files.
In addition to this, many modern websites use \textit{webpack}\footnote{\url{https://webpack.js.org/}}
or a similar technology to combine multiple JavaScript files into one when serving
them to their users. This could lead a non-fingerprinting site to be labeled
more likely to fingerprint than it actually is.

\section{Algorithm}
As mentioned in Chapter~\ref{chap:data_acquisition}, PrivacyScore uses one of six distinct values
to rate a characteristic of a site. Our algorithm shall therefore produce a rating on a
six-value scale. The higher this score, the more confident we are that a website employs
fingerprinting. As discussed in Section~\ref{sec:data_discussion}, we have listed
certain giveaways, like the magic strings that are exclusively used in fingerprinting.
Should we find any of these, we can immediately set the score to its highest possible
value.
Otherwise, we must increment the score for every fingerprintable API we find.
We will give a perfect score of zero, which indicates no fingerprinting, only
if a site uses no fingerprintable attributes or APIs.
This is a rare case, as many modern sites use at least the \textit{languages}
attribute to set the user's language, or the \textit{userAgent} string to
perform certain user-experience enhancing optimizations.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter End                                                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter Start                                                            %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Conclusion and Outlook}
\label{chap:conclusion}
This thesis was terrific and there's lots of cool stuff to look out for.

\section{Future Work}
\todo{mention WebAssembly}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Chapter End                                                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% }}



% \begingroup
% \renewcommand{\cleardoublepage}{}
% \renewcommand{\clearpage}{}
% \chapter{Methods and Approach} % {{
% \endgroup
%
% \section{False Positives}
% Filtering false positives will prove to be the most challenging problem in this context.
% Requesting fonts via JavaScript might be a dead giveaway
% that fingerprinting code is, in fact, fingerprinting code. However, it might cause legitimate code, such
% as a multimedia player, to be mistaken for fingerprinting code, as well, even though it has a legitimate
% reason and perhaps a necessity to know a system's installed fonts.
% Meta-data can and possibly must be used to filter these; a list can be compiled of popular JavaScript libraries with legitimate,
% yet fingerprinting-like behavior, and then extended through analysis of collected data (see Technology below).
%
% All results must be evaluated regarding both precision and recall. Suppose a fingerprinting-recognition software
% analyses 100 websites. It reports that 50 of them employ fingerprinting, and that the other 50 do not.
% In reality, however, only 40 of the 50 ``positives'' actually do employ fingerprinting, but a total
% of 80 of all the analysed sites employ it.
% The precision of this software would then be $40/50 = 4/5$, as 40 out of 50 of its reported positives were correct.
% Its recall would be $40/80 = 1/2$, as it only reported 40 positives out of 80 actual positives.
% One might say that precision describes the usefulness of the results, while recall describes their completeness.
%
% \section{Metric}
% If a website includes a well-known browser fingerprinting library, or makes many calls to JavaScript functions that return
% data which is useful in building a fingerprint, one can conclude: this website is very likely generating,
% saving, and possibly distributing a browser's fingerprint; simply put: it performs browser fingerprinting.
% However, some modern websites may exhibit some similar traits or behavior that can be used to construct a fingerprint
% for reasons other than identification. Analyzing installed fonts has an obvious, legitimate use: correctly displaying
% text. Thus, it is important to work out a metric or rating system of some sort, which can
% (somewhat) reliably represent the likelihood that fingerprinting is, in fact, taking place.
% Acar et al. assert that the more fonts are being requested, the more likely a website is to
% be practicing fingerprinting \cite{DBLP:conf/ccs/AcarJNDGPP13}.
% This is based on findings of Eckersley, of the Panopticlick project \cite{eckersley2010unique}.
% Acar et al. further state that they classify a JavaScript file as a fingerprinter ``when it loads
% more than 30 fonts, enumerates plugins or mimeTypes, detects screen and navigator properties, and sends the
% collected data back to a remote server'' \cite{DBLP:conf/ccs/AcarJNDGPP13}.
% Englehardt and Narayanan present a metric to detect Canvas-based fingerprinting by specifying certain
% attributes such a Canvas, and the code using it, should have \cite{DBLP:conf/ccs/EnglehardtN16}.
% The above considerations form a good basis upon which to build a reliable metric, which will have to be
% evaluated further during the implementation process.
%
% \section{Scope}
% Finding or creating a single website which collects a fingerprint, and basing development of fingerprinting
% recognition on it, will not yield reliable or representative results. It is imperative to test
% the created recognition software against a multitude of fingerprinting libraries and users of these.
% It will be prudent to test the software against, say, the top 500 websites as ranked by
% Alexa\footnote{\url{http://www.alexa.com/topsites}}, as there is a high likelihood these sites employ
% a multitude of techniques to track their users, but there is no way to be sure if some of these sites wouldn't
% generate false positives.
% The safest way would be to create websites which employ an array of fingerprinting libraries both preexisting and
% implemented by the author, and then comparing the employed JavaScript calls with those from popular websites.
% The best approach seems to be a combination of the above; create a set of fake websites, some of which employ fingerprinting,
% others mimicking it. Then the results from analyzing them will be compared to the results from analyzing top Alexa sites.
%
% % }}

\begin{appendices}

\chapter{OpenWPM Browser Params}
The following configuration for OpenWPM's \textit{default\_browser\_params} was used.
\todo{add a bit more description, why not?}

\definecolor{mintedbg}{rgb}{0.95,0.95,0.95}
\setminted{fontsize=\footnotesize,bgcolor=mintedbg}

\begin{figure}
\label{app:params}
\begin{minted}{json}
{
    "extension_enabled": true,
    "cookie_instrument": true,
    "js_instrument": true,
    "cp_instrument": true,
    "http_instrument": true,
    "save_javascript": false,
    "save_all_content": false,

    "random_attributes": false,
    "bot_mitigation": false,
    "disable_flash": true,
    "profile_tar": null,
    "profile_archive_dir": null,
    "headless": true,
    "browser": "firefox",
    "prefs": {},

    "tp_cookies": "always",
    "donottrack": false,
    "disconnect": false,
    "ghostery": false,
    "https-everywhere": false,
    "adblock-plus": false,
    "ublock-origin": false,
    "tracking-protection": false
}
\end{minted}
\caption{The Browser Parameters used by OpenWPM in our Crawls}
\end{figure}


\chapter{Canvas Fingerprinting Example}
\begin{figure}
\begin{minted}[linenos]{javascript}
getCanvasFp: function() {
  var result = [];
  var canvas = document.createElement("canvas");
  canvas.width = 2000;
  canvas.height = 200;
  canvas.style.display = "inline";
  var ctx = canvas.getContext("2d");
  ctx.rect(0, 0, 10, 10);
  ctx.rect(2, 2, 6, 6);
  result.push(
    "canvas winding:"
    + ((ctx.isPointInPath(5, 5, "evenodd") === false) ? "yes" : "no")
  );

  ctx.textBaseline = "alphabetic";
  ctx.fillStyle = "#f60";
  ctx.fillRect(125, 1, 62, 20);
  ctx.fillStyle = "#069";
  if(this.options.dontUseFakeFontInCanvas) {
    ctx.font = "11pt Arial";
  } else {
    ctx.font = "11pt no-real-font-123";
  }
  ctx.fillText("Cwm fjordbank glyphs vext quiz, \ud83d\ude03", 2, 15);
  ctx.fillStyle = "rgba(102, 204, 0, 0.2)";
  ctx.font = "18pt Arial";
  ctx.fillText("Cwm fjordbank glyphs vext quiz, \ud83d\ude03", 4, 45);

  ctx.globalCompositeOperation = "multiply";
  ctx.fillStyle = "rgb(255,0,255)";
  ctx.beginPath();
  ctx.arc(50, 50, 50, 0, Math.PI * 2, true);
  ctx.closePath();
  ctx.fill();
  ctx.fillStyle = "rgb(0,255,255)";
  ctx.beginPath();
  ctx.arc(100, 50, 50, 0, Math.PI * 2, true);
  ctx.closePath();
  ctx.fill();
  ctx.fillStyle = "rgb(255,255,0)";
  ctx.beginPath();
  ctx.arc(75, 100, 50, 0, Math.PI * 2, true);
  ctx.closePath();
  ctx.fill();
  ctx.fillStyle = "rgb(255,0,255)";
  ctx.arc(75, 75, 75, 0, Math.PI * 2, true);
  ctx.arc(75, 75, 25, 0, Math.PI * 2, true);
  ctx.fill("evenodd");

  result.push("canvas fp:" + canvas.toDataURL());
  return result.join("~");
},
\end{minted}
\caption{Example of Canvas Fingerprinting, taken from Fingerprintjs2}
\label{app:canvas_fp}
\end{figure}

The code of Figure~\ref{app:canvas_fp} displays fingerprinting code
using the Canvas API. It was taken from Fingerprintjs2 (cf. Sec.~\ref{related_work:fingerprintjs2}).
We have made minimal modifications by removing comments for the sake of brevity, and changing
long lines to make the code fit onto the page.
The code is otherwise shown as-is, with not modifications that alter its functionality.


\chapter{\textit{mmmmmmmmmmlli} Magic String Use}
\begin{figure}
\begin{minted}[linenos]{javascript}
tb = function() {
    var a = ["monospace", "sans-serif", "serif"],
        b = document.getElementsByTagName("body")[0],
        c = document.createElement("div");
    c.setAttribute(
        "style",
        "visibility: hidden;position: absolute; top: 0px; left: -999px;"
    );
    b.appendChild(c);
    b = document.createElement("span");
    b.style.fontSize = "72px";
    b.innerHTML = "mmmmmmmmmmlli";
    var d = {},
        e = {},
        f;
    for (f in a) {
        b.style.fontFamily = a[f];
        c.appendChild(b);
        d[a[f]] = b.offsetWidth;
        e[a[f]] = b.offsetHeight;
        c.removeChild(b);
    }
    this.detect = function(b) {
        var f = document.createElement("div");
        f.setAttribute(
            "style",
            "visibility: hidden;position: absolute; top: 0px; left: -999px;"
        );
        for (var g = [], k = [], h = 0; h < b.length; h++) {
            var l = [];
            k.push(!1);
            for (var n in a) {
                var p = document.createElement("div"),
                    q = document.createElement("span");
                q.style.fontSize = "72px";
                q.innerHTML = "mmmmmmmmmmlli";
                q.style.fontFamily = b[h] + "," + a[n];
                p.appendChild(q);
                f.appendChild(p);
                l.push(q)
            }
            g.push(l)
        }
        c.appendChild(f);
        for (h = 0; h < b.length; h++)
            for (n in l = g[h], a) {
                q = l[n];
                p = q.offsetWidth != d[a[n]] || q.offsetHeight != e[a[n]];
                k[h] = k[h] || p;
            }
        c.removeChild(f);
        return k
    }
},
\end{minted}
\caption{Example of \textit{mmmmmmmmmmlli} magic string use by \url{bankofamerica.com}}
\label{app:mmmmmmmmmmlli}
\end{figure}

The code in Figure~\ref{app:mmmmmmmmmmlli} was taken from a script served by \url{bankofamerica.com}.
It is not a complete script, but rather just one function definition in a larger script.
We have ``beautified'' the code using DuckDuckGo's JavaScript beautifier, written by Akansh Gulati\footnote{\url{https://github.com/akanshgulati}}.
We have also modified the beautified code further to eliminate long lines, thus allowing it to be displayed
on this page.
We have not made any functional modifications.

The code demonstrates the use of the \textit{mmmmmmmmmmlli} magic string in a \textit{span} HTML element.
It is used for font fingerprinting without the use of a Canvas element.
The original URL of the full JavaScript was \url{https://secure.bankofamerica.com/login/sign-in/cc.go}.

In the code, multiple \textit{span} elements are created and inserted into the DOM,
each containing the magic string with a font size of 72 pixels, and with their font-family
set to different combinations of fonts and the font types ``monospace'', ``sans-serif'' and ``serif''.
These elements are invisible from the user.
Their \textit{offsetWidth} and \textit{offsetHeight} properties are read, saved, and
used for fingerprinting.
These properties can reveal whether a font is available on the system, because
if the font is not available, they will be the same as for the default, fallback
font. So, if they differ for a certain font, that font is installed. If they do not,
the font is not installed.
The list of fonts used contains 300 entries, but is not shown for the sake of brevity.


\end{appendices}

\clearpage

\printbibliography

\end{document}
